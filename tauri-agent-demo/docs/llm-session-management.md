# LLM Session ç®¡ç†æ¶æ„è§£æ

## æ ¸å¿ƒé—®é¢˜

1. å¯¹å¤§æ¨¡å‹çš„è¯·æ±‚æ˜¯ç‹¬ç«‹çš„ session å—ï¼Ÿ
2. å¦‚ä½•å®ç°å¹¶è¡Œå¯¹è¯ï¼Ÿ
3. Session ç®¡ç†åœ¨å“ªä¸€å±‚ï¼Ÿ

---

## ç®€çŸ­å›ç­”

âœ… **æ˜¯çš„ï¼Œä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼**

1. **æ¯æ¬¡ LLM API è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ã€æ— çŠ¶æ€çš„**
2. **Sessionï¼ˆä¼šè¯ï¼‰çš„æ¦‚å¿µæ˜¯åº”ç”¨å±‚ç»´æŠ¤çš„ï¼Œä¸æ˜¯ LLM API ç»´æŠ¤çš„**
3. **å¹¶è¡Œå¯¹è¯åªéœ€è¦åœ¨åº”ç”¨å±‚åšå¥½ session åŒºåˆ†å³å¯**

---

## è¯¦ç»†è§£æ

### 1. LLM API çš„è¯·æ±‚ç‰¹æ€§

#### â­ å®Œå…¨æ— çŠ¶æ€ï¼ˆStatelessï¼‰

å¤§æ¨¡å‹çš„ APIï¼ˆOpenAIã€DeepSeekã€æ™ºè°±ç­‰ï¼‰éƒ½æ˜¯**å®Œå…¨æ— çŠ¶æ€**çš„ï¼š

```python
# è¯·æ±‚1
POST https://api.openai.com/v1/chat/completions
{
    "model": "gpt-4",
    "messages": [
        {"role": "user", "content": "ä½ å¥½"}
    ]
}
# å“åº”1: "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹..."

# è¯·æ±‚2ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼ŒAPIä¸è®°å¾—è¯·æ±‚1ï¼‰
POST https://api.openai.com/v1/chat/completions
{
    "model": "gpt-4",
    "messages": [
        {"role": "user", "content": "æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆï¼Ÿ"}
    ]
}
# å“åº”2: "æŠ±æ­‰ï¼Œæˆ‘ä¸çŸ¥é“ä½ ä¹‹å‰è¯´äº†ä»€ä¹ˆ..."
```

**å…³é”®ç‚¹ï¼š**
- âŒ LLM API **ä¸ä¿å­˜ä»»ä½•å¯¹è¯å†å²**
- âŒ LLM API **ä¸ç»´æŠ¤ session æ¦‚å¿µ**
- âŒ API ä¹‹é—´**æ²¡æœ‰ä»»ä½•å…³è”**
- âœ… æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯**å®Œå…¨ç‹¬ç«‹çš„**

#### å¦‚ä½•å®ç°"è®°å¿†"æ•ˆæœï¼Ÿ

**ç­”æ¡ˆï¼šåº”ç”¨å±‚æ‰‹åŠ¨ç»„è£…å†å²æ¶ˆæ¯**

```python
# è¦è®© LLM "è®°ä½"ä¹‹å‰çš„å¯¹è¯ï¼Œéœ€è¦æ¯æ¬¡éƒ½å‘é€å®Œæ•´å†å²
POST https://api.openai.com/v1/chat/completions
{
    "model": "gpt-4",
    "messages": [
        {"role": "user", "content": "ä½ å¥½"},                    # å†å²1
        {"role": "assistant", "content": "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹"}, # å†å²2
        {"role": "user", "content": "æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆï¼Ÿ"}        # å½“å‰æ¶ˆæ¯
    ]
}
# å“åº”: "ä½ åˆšæ‰è¯´äº†'ä½ å¥½'"
```

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨å±‚ç»´æŠ¤ sessionï¼**

---

### 2. Session ç®¡ç†åœ¨å“ªä¸€å±‚ï¼Ÿ

ç­”æ¡ˆï¼š**å®Œå…¨åœ¨åº”ç”¨å±‚ï¼ˆä½ çš„åç«¯ï¼‰**

#### å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ï¼ˆUIï¼‰                         â”‚
â”‚   - æ˜¾ç¤ºå¤šä¸ªå¯¹è¯çª—å£                 â”‚
â”‚   - åˆ‡æ¢ä¸åŒ session                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP Request (session_id)
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚ï¼ˆä½ çš„åç«¯ï¼‰                 â”‚
â”‚   - ç»´æŠ¤ session_id â†’ æ¶ˆæ¯åˆ—è¡¨      â”‚  â† â­ Session ç®¡ç†åœ¨è¿™é‡Œ
â”‚   - ç»„è£…å†å²æ¶ˆæ¯                     â”‚
â”‚   - å­˜å‚¨åˆ°æ•°æ®åº“                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ç‹¬ç«‹çš„ HTTP Requestï¼ˆæ— çŠ¶æ€ï¼‰
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM APIï¼ˆOpenAI/DeepSeekç­‰ï¼‰      â”‚
â”‚   - æ¥æ”¶æ¶ˆæ¯åˆ—è¡¨                     â”‚  â† ä¸çŸ¥é“ session
â”‚   - ç”Ÿæˆå“åº”                         â”‚  â† å®Œå…¨æ— çŠ¶æ€
â”‚   - è¿”å›ç»“æœ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä½ çš„é¡¹ç›®ä¸­çš„å®ç°

**æ•°æ®åº“ï¼ˆ`database.py`ï¼‰ï¼š**
```python
# Session è¡¨
chat_sessions:
    - id (session_id)          # â† å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå¯¹è¯
    - title
    - config_id
    - created_at

# Message è¡¨
chat_messages:
    - id
    - session_id               # â† é€šè¿‡è¿™ä¸ªå…³è”åˆ° session
    - role
    - content
    - timestamp
```

**åç«¯ APIï¼ˆ`main.py`ï¼‰ï¼š**
```python
@app.post("/chat")
async def chat(request: ChatRequest):
    # 1. è·å– sessionï¼ˆåº”ç”¨å±‚ç»´æŠ¤ï¼‰
    session = db.get_session(request.session_id)
    
    # 2. è·å–è¯¥ session çš„å†å²æ¶ˆæ¯ï¼ˆåº”ç”¨å±‚ç»´æŠ¤ï¼‰
    history = db.get_session_messages(session.id, limit=20)
    
    # 3. ç»„è£…æ¶ˆæ¯åˆ—è¡¨ï¼ˆåº”ç”¨å±‚ç»„è£…ï¼‰
    llm_messages = build_messages_for_llm(
        user_message=request.message,
        history=history_for_llm
    )
    
    # 4. å‘é€åˆ° LLMï¼ˆæ— çŠ¶æ€è¯·æ±‚ï¼‰
    llm_result = await llm_client.chat(llm_messages)  # â† LLM ä¸çŸ¥é“ session
    
    # 5. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåº”ç”¨å±‚ç»´æŠ¤ï¼‰
    db.create_message(ChatMessageCreate(
        session_id=session.id,  # â† å…³è”åˆ° session
        role="assistant",
        content=llm_result["content"]
    ))
```

---

### 3. å¹¶è¡Œå¯¹è¯çš„å®ç°

#### åœºæ™¯ï¼šç”¨æˆ·åŒæ—¶æ‰“å¼€3ä¸ªå¯¹è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¹è¯çª—å£ A  â”‚  â”‚  å¯¹è¯çª—å£ B  â”‚  â”‚  å¯¹è¯çª—å£ C  â”‚
â”‚  session_a  â”‚  â”‚  session_b  â”‚  â”‚  session_c  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â†“                â†“                â†“
    [è¯·æ±‚A]          [è¯·æ±‚B]          [è¯·æ±‚C]
       â†“                â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä½ çš„åç«¯æœåŠ¡å™¨                      â”‚
â”‚                                                â”‚
â”‚  å¤„ç†è¯·æ±‚A:                                    â”‚
â”‚  - session_id = "session_a"                   â”‚
â”‚  - è·å– session_a çš„å†å²                       â”‚
â”‚  - ç»„è£…æ¶ˆæ¯å‘é€ç»™ LLM                          â”‚
â”‚                                                â”‚
â”‚  å¤„ç†è¯·æ±‚Bï¼ˆå¹¶è¡Œï¼‰:                             â”‚
â”‚  - session_id = "session_b"                   â”‚
â”‚  - è·å– session_b çš„å†å²                       â”‚  â† session éš”ç¦»
â”‚  - ç»„è£…æ¶ˆæ¯å‘é€ç»™ LLM                          â”‚
â”‚                                                â”‚
â”‚  å¤„ç†è¯·æ±‚Cï¼ˆå¹¶è¡Œï¼‰:                             â”‚
â”‚  - session_id = "session_c"                   â”‚
â”‚  - è·å– session_c çš„å†å²                       â”‚
â”‚  - ç»„è£…æ¶ˆæ¯å‘é€ç»™ LLM                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                â†“                â†“
    [å“åº”A]          [å“åº”B]          [å“åº”C]
```

#### å…³é”®æœºåˆ¶

**âœ… 1. Session ID éš”ç¦»**

```python
# è¯·æ±‚A
{
    "message": "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ",
    "session_id": "session_a"  # â† ä¼šè¯A
}

# è¯·æ±‚Bï¼ˆåŒæ—¶å‘é€ï¼‰
{
    "message": "æ¨èä¸€æœ¬ä¹¦",
    "session_id": "session_b"  # â† ä¼šè¯Bï¼Œå®Œå…¨ç‹¬ç«‹
}
```

**åç«¯å¤„ç†ï¼š**
```python
# è¯·æ±‚Açš„å¤„ç†
history_a = db.get_session_messages("session_a")  # åªè·å–Açš„å†å²
llm_messages_a = [...]  # åªåŒ…å«Açš„å¯¹è¯

# è¯·æ±‚Bçš„å¤„ç†ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
history_b = db.get_session_messages("session_b")  # åªè·å–Bçš„å†å²
llm_messages_b = [...]  # åªåŒ…å«Bçš„å¯¹è¯

# ä¸¤ä¸ªè¯·æ±‚äº’ä¸å¹²æ‰°ï¼âœ…
```

**âœ… 2. æ•°æ®åº“å±‚é¢çš„éš”ç¦»**

```sql
-- è·å– session A çš„æ¶ˆæ¯
SELECT * FROM chat_messages WHERE session_id = 'session_a';

-- è·å– session B çš„æ¶ˆæ¯
SELECT * FROM chat_messages WHERE session_id = 'session_b';

-- ä¸¤ä¸ªæŸ¥è¯¢è¿”å›å®Œå…¨ä¸åŒçš„æ•°æ®
```

**âœ… 3. HTTP è¯·æ±‚çš„éš”ç¦»**

```python
# å‘ LLM å‘é€è¯·æ±‚A
request_a = await llm_client.chat(messages_a)  # Promise A

# å‘ LLM å‘é€è¯·æ±‚Bï¼ˆå¹¶è¡Œï¼‰
request_b = await llm_client.chat(messages_b)  # Promise B

# HTTP åè®®ä¿è¯ Promise A åªä¼šæ”¶åˆ°è¯·æ±‚Açš„å“åº”
# Promise B åªä¼šæ”¶åˆ°è¯·æ±‚Bçš„å“åº”
```

---

### 4. å®é™…ä»£ç ç¤ºä¾‹

#### å‰ç«¯ï¼šå¹¶è¡Œå‘é€è¯·æ±‚

```typescript
// ç”¨æˆ·åœ¨å¯¹è¯Aä¸­å‘é€æ¶ˆæ¯
const handleSendA = async () => {
    const response = await sendMessage({
        message: "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ",
        session_id: "session_a",  // â† æŒ‡å®š session A
        config_id: currentConfig?.id
    });
    // response åŒ…å« session_a çš„ä¸Šä¸‹æ–‡å›å¤
};

// åŒæ—¶ï¼Œç”¨æˆ·åœ¨å¯¹è¯Bä¸­å‘é€æ¶ˆæ¯ï¼ˆå¹¶è¡Œï¼‰
const handleSendB = async () => {
    const response = await sendMessage({
        message: "æ¨èä¸€æœ¬ä¹¦",
        session_id: "session_b",  // â† æŒ‡å®š session B
        config_id: currentConfig?.id
    });
    // response åŒ…å« session_b çš„ä¸Šä¸‹æ–‡å›å¤
};

// âœ… ä¸¤ä¸ªè¯·æ±‚å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
```

#### åç«¯ï¼šè‡ªåŠ¨éš”ç¦»å¤„ç†

```python
@app.post("/chat")
async def chat(request: ChatRequest):
    # FastAPI ä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡
    # å³ä½¿åŒæ—¶æ”¶åˆ°å¤šä¸ªè¯·æ±‚ï¼Œä¹Ÿä¼šå¹¶è¡Œå¤„ç†
    
    session_id = request.session_id  # "session_a" æˆ– "session_b"
    
    # è·å–è¯¥ session çš„å†å²ï¼ˆè‡ªåŠ¨éš”ç¦»ï¼‰
    history = db.get_session_messages(session_id)
    
    # å‘é€ç»™ LLMï¼ˆç‹¬ç«‹çš„ HTTP è¯·æ±‚ï¼‰
    llm_result = await llm_client.chat(messages)
    
    # ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå…³è”åˆ°æ­£ç¡®çš„ sessionï¼‰
    db.create_message(ChatMessageCreate(
        session_id=session_id,
        role="assistant",
        content=llm_result["content"]
    ))
    
    # âœ… å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°
```

---

## å…³é”®è®¾è®¡åŸåˆ™

### âœ… 1. LLM API å±‚é¢

- **å®Œå…¨æ— çŠ¶æ€**ï¼šæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹
- **ä¸ç»´æŠ¤ session**ï¼šAPI ä¸çŸ¥é“å¯¹è¯å†å²
- **æ— å¹¶å‘é™åˆ¶**ï¼šå¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚

### âœ… 2. åº”ç”¨å±‚é¢

- **ç»´æŠ¤ session**ï¼šåœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¼šè¯å’Œæ¶ˆæ¯
- **session_id éš”ç¦»**ï¼šé€šè¿‡ ID åŒºåˆ†ä¸åŒå¯¹è¯
- **ç»„è£…å†å²**ï¼šæ¯æ¬¡è¯·æ±‚æ—¶ç»„è£…è¯¥ session çš„å†å²

### âœ… 3. å¹¶è¡Œå¯¹è¯

- **åªéœ€è¦ session åŒºåˆ†**ï¼šåº”ç”¨å±‚ç»´æŠ¤ä¸åŒçš„ session_id
- **æ•°æ®åº“éš”ç¦»**ï¼šé€šè¿‡ `WHERE session_id = ?` æŸ¥è¯¢
- **HTTP å±‚é¢è‡ªç„¶éš”ç¦»**ï¼šä¸åŒçš„è¯·æ±‚è‡ªåŠ¨å¯¹åº”ä¸åŒçš„å“åº”

---

## å¹¶å‘åœºæ™¯åˆ†æ

### åœºæ™¯ 1ï¼šåŒä¸€ Session å¿«é€Ÿå‘é€å¤šæ¡

```typescript
// âš ï¸ åŒä¸€ä¸ª sessionï¼Œå¿«é€Ÿå‘é€2æ¡æ¶ˆæ¯
await sendMessage({message: "æ¶ˆæ¯1", session_id: "abc"});
await sendMessage({message: "æ¶ˆæ¯2", session_id: "abc"});
```

**ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
1. è¯·æ±‚1å‘é€ï¼ŒåŒ…å«å†å² [msg0]
2. è¯·æ±‚1è¿”å›ï¼Œä¿å­˜ msg1 åˆ°æ•°æ®åº“
3. è¯·æ±‚2å‘é€ï¼ŒåŒ…å«å†å² [msg0, msg1]  âœ…
4. è¯·æ±‚2è¿”å›ï¼Œä¿å­˜ msg2 åˆ°æ•°æ®åº“

**âœ… æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºï¼š**
- æ¯æ¬¡éƒ½ä»æ•°æ®åº“é‡æ–°è¯»å–æœ€æ–°å†å²
- è¯·æ±‚æ˜¯é¡ºåºçš„ï¼ˆ`await`ï¼‰

### åœºæ™¯ 2ï¼šåŒä¸€ Session å¹¶å‘å‘é€

```typescript
// âš ï¸ åŒä¸€ä¸ª sessionï¼ŒåŒæ—¶å‘é€2æ¡æ¶ˆæ¯ï¼ˆä¸æ¨èï¼‰
Promise.all([
    sendMessage({message: "æ¶ˆæ¯1", session_id: "abc"}),
    sendMessage({message: "æ¶ˆæ¯2", session_id: "abc"})
]);
```

**ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
1. è¯·æ±‚1å’Œè¯·æ±‚2å‡ ä¹åŒæ—¶å‘é€
2. ä¸¤ä¸ªè¯·æ±‚éƒ½è¯»å–ç›¸åŒçš„å†å² [msg0]
3. ä¸¤ä¸ªè¯·æ±‚ç‹¬ç«‹è°ƒç”¨ LLM
4. ä¸¤ä¸ªå“åº”å¯èƒ½ä¸ä¸€è‡´ï¼ˆå› ä¸ºä¸Šä¸‹æ–‡ç›¸åŒï¼‰

**âš ï¸ å¯èƒ½æœ‰é—®é¢˜ï¼š**
- ä¸¤ä¸ªè¯·æ±‚çœ‹åˆ°ç›¸åŒçš„å†å²
- LLM å“åº”å¯èƒ½é‡å¤æˆ–ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆï¼š**
- å‰ç«¯ç¦ç”¨å¹¶å‘ï¼ˆåŒä¸€ session åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè¯·æ±‚ï¼‰
- æˆ–è€…ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºå¤„ç†

### åœºæ™¯ 3ï¼šä¸åŒ Session å¹¶å‘å‘é€

```typescript
// âœ… ä¸åŒ sessionï¼ŒåŒæ—¶å‘é€ï¼ˆå®Œå…¨æ²¡é—®é¢˜ï¼‰
Promise.all([
    sendMessage({message: "æ¶ˆæ¯1", session_id: "session_a"}),
    sendMessage({message: "æ¶ˆæ¯2", session_id: "session_b"}),
    sendMessage({message: "æ¶ˆæ¯3", session_id: "session_c"})
]);
```

**ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
1. ä¸‰ä¸ªè¯·æ±‚å¹¶å‘å‘é€
2. åç«¯å¹¶è¡Œå¤„ç†ï¼Œå„è‡ªè·å–å¯¹åº” session çš„å†å²
3. ä¸‰ä¸ªç‹¬ç«‹çš„ LLM è°ƒç”¨
4. ä¸‰ä¸ªå“åº”å„è‡ªä¿å­˜åˆ°å¯¹åº”çš„ session

**âœ… å®Œå…¨æ²¡é—®é¢˜ï¼**
- Session ä¹‹é—´å®Œå…¨éš”ç¦»
- æ•°æ®åº“æŸ¥è¯¢ä¸ä¼šäº¤å‰
- LLM å“åº”å„è‡ªç‹¬ç«‹

---

## æœ€ä½³å®è·µ

### âœ… æ¨èçš„æ¶æ„

```typescript
// å‰ç«¯ï¼šæ¯ä¸ª session ä¸€ä¸ªèŠå¤©çª—å£
const ChatWindow = ({sessionId}: {sessionId: string}) => {
    const [messages, setMessages] = useState<Message[]>([]);
    const [loading, setLoading] = useState(false);
    
    const handleSend = async (message: string) => {
        // âœ… åŒä¸€ session ä¸å…è®¸å¹¶å‘
        if (loading) return;
        setLoading(true);
        
        try {
            await sendMessage({
                message,
                session_id: sessionId  // â† æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ session_id
            });
            
            // é‡æ–°åŠ è½½è¯¥ session çš„æ¶ˆæ¯
            const updatedMessages = await getSessionMessages(sessionId);
            setMessages(updatedMessages);
        } finally {
            setLoading(false);
        }
    };
};

// ç”¨æˆ·å¯ä»¥æ‰“å¼€å¤šä¸ªçª—å£ï¼Œå„è‡ªç‹¬ç«‹
<ChatWindow sessionId="session_a" />
<ChatWindow sessionId="session_b" />
<ChatWindow sessionId="session_c" />
```

### âœ… åç«¯è‡ªåŠ¨å¤„ç†å¹¶å‘

```python
@app.post("/chat")
async def chat(request: ChatRequest):
    # FastAPI è‡ªåŠ¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
    # ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†å¹¶å‘
    
    # åªè¦ session_id ä¸åŒï¼Œå°±å®Œå…¨éš”ç¦» âœ…
    session = db.get_session(request.session_id)
    history = db.get_session_messages(request.session_id)
    
    # å¹¶å‘çš„ LLM è°ƒç”¨
    llm_result = await llm_client.chat(messages)
    
    # ä¿å­˜åˆ°å„è‡ªçš„ session
    db.create_message(ChatMessageCreate(
        session_id=request.session_id,
        role="assistant",
        content=llm_result["content"]
    ))
```

---

## æ€»ç»“

### å›ç­”ä½ çš„é—®é¢˜

**Q1: å¯¹å¤§æ¨¡å‹çš„è¯·æ±‚ä¸€èˆ¬éƒ½æ˜¯ä¸€æ¬¡å•ç‹¬çš„ session å—ï¼Ÿ**
- âŒ ä¸æ˜¯ï¼LLM API æœ¬èº«**æ²¡æœ‰ session æ¦‚å¿µ**
- âœ… æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯**å®Œå…¨ç‹¬ç«‹çš„ã€æ— çŠ¶æ€çš„**
- âœ… Session æ˜¯**åº”ç”¨å±‚çš„æ¦‚å¿µ**ï¼Œç”±ä½ çš„åç«¯ç»´æŠ¤

**Q2: å¹¶è¡Œå¯¹è¯åªç”¨åœ¨åº”ç”¨å±‚åšå¥½ session åŒºåˆ†å°±è¡Œäº†å—ï¼Ÿ**
- âœ… **æ˜¯çš„ï¼Œå®Œå…¨æ­£ç¡®ï¼**
- âœ… åªè¦ `session_id` ä¸åŒï¼Œå°±è‡ªåŠ¨éš”ç¦»
- âœ… æ•°æ®åº“ã€HTTP è¯·æ±‚ã€LLM è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨éš”ç¦»
- âœ… ä¸éœ€è¦å…¶ä»–å±‚é¢çš„ç‰¹æ®Šå¤„ç†

### å…³é”®ç‚¹

| å±‚æ¬¡ | Session ç®¡ç† |
|-----|-------------|
| **LLM API** | âŒ æ— çŠ¶æ€ï¼Œä¸ç»´æŠ¤ session |
| **ä½ çš„åç«¯** | âœ… ç»´æŠ¤ sessionï¼Œç»„è£…å†å²æ¶ˆæ¯ |
| **æ•°æ®åº“** | âœ… å­˜å‚¨ session å’Œæ¶ˆæ¯çš„å…³è” |
| **å‰ç«¯** | âœ… é€šè¿‡ session_id åˆ‡æ¢ä¸åŒå¯¹è¯ |

**ä½ åªéœ€è¦ï¼š**
1. æ¯ä¸ªå¯¹è¯åˆ†é…å”¯ä¸€çš„ `session_id`
2. æ•°æ®åº“ä¸­é€šè¿‡ `session_id` å…³è”æ¶ˆæ¯
3. æ¯æ¬¡è¯·æ±‚æ—¶å¸¦ä¸Š `session_id`
4. åç«¯æ ¹æ® `session_id` è·å–å†å²å¹¶ç»„è£…

å°±è¿™ä¹ˆç®€å•ï¼ğŸ‰
