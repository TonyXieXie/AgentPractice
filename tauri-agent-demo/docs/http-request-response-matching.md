# HTTP è¯·æ±‚-å“åº”å¯¹åº”å…³ç³»ä¿è¯æœºåˆ¶

## é—®é¢˜

å½“å‰ç«¯åŒæ—¶å‘é€å¤šä¸ª HTTP è¯·æ±‚æ—¶ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªè¯·æ±‚èƒ½æ­£ç¡®æ”¶åˆ°å¯¹åº”çš„å“åº”ï¼Ÿä¾‹å¦‚ï¼š

```typescript
// åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚
const req1 = fetch('/api/chat', {body: 'æ¶ˆæ¯1'});
const req2 = fetch('/api/chat', {body: 'æ¶ˆæ¯2'});
const req3 = fetch('/api/chat', {body: 'æ¶ˆæ¯3'});

// å¦‚ä½•ä¿è¯ req1 çš„å“åº”æ˜¯é’ˆå¯¹"æ¶ˆæ¯1"çš„ï¼Ÿ
```

---

## ç­”æ¡ˆï¼šå¤šå±‚æœºåˆ¶ä¿è¯

HTTP è¯·æ±‚-å“åº”çš„å¯¹åº”å…³ç³»ç”±**å¤šä¸ªåè®®å±‚**å…±åŒä¿è¯ï¼Œä»åº•å±‚åˆ°é«˜å±‚åˆ†åˆ«æ˜¯ï¼š

### 1ï¸âƒ£ TCP å±‚é¢ï¼ˆä¼ è¾“å±‚ï¼‰

**æœºåˆ¶ï¼šTCP è¿æ¥çš„æœ‰åºæ€§**

- æ¯ä¸ª HTTP è¯·æ±‚é€šè¿‡ä¸€ä¸ª TCP è¿æ¥å‘é€
- TCP ä¿è¯æ•°æ®åŒ…çš„**é¡ºåºæ€§**å’Œ**å®Œæ•´æ€§**
- å³ä½¿ç½‘ç»œä¸­ä¹±åºï¼ŒTCP ä¹Ÿä¼šé‡æ–°æ’åº

**HTTP/1.1 çš„è¡Œä¸ºï¼š**
```
                æ—¶é—´è½´ â†’
è¿æ¥1: [è¯·æ±‚1] â†’ [ç­‰å¾…] â†’ [å“åº”1]
è¿æ¥2: [è¯·æ±‚2] â†’ [ç­‰å¾…] â†’ [å“åº”2]  
è¿æ¥3: [è¯·æ±‚3] â†’ [ç­‰å¾…] â†’ [å“åº”3]
```

- æ¯ä¸ªè¯·æ±‚ç‹¬å ä¸€ä¸ªè¿æ¥ï¼ˆæˆ–å¤ç”¨è¿æ¥ï¼‰
- åœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šï¼Œå“åº”å¿…é¡»æŒ‰è¯·æ±‚çš„é¡ºåºè¿”å›ï¼ˆhead-of-line blockingï¼‰

---

### 2ï¸âƒ£ HTTP åè®®å±‚é¢ï¼ˆåº”ç”¨å±‚ï¼‰

**æœºåˆ¶ï¼šè¯·æ±‚-å“åº”æ¨¡å‹**

HTTP æ˜¯å…¸å‹çš„**è¯·æ±‚-å“åº”åè®®**ï¼š
- ä¸€ä¸ªè¯·æ±‚ï¼ˆRequestï¼‰å¯¹åº”ä¸€ä¸ªå“åº”ï¼ˆResponseï¼‰
- å“åº”ä¸­åŒ…å«çš„ä¿¡æ¯å®Œå…¨æ˜¯é’ˆå¯¹è¯¥è¯·æ±‚çš„

**å…³é”®ç‰¹æ€§ï¼š**

#### A. è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰

**HTTP/1.1:**
```http
Connection: keep-alive
```
- å…è®¸åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸Šå‘é€å¤šä¸ªè¯·æ±‚
- ä½†å“åº”å¿…é¡»æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè¿”å›

**HTTP/2:**
```
                å¤šè·¯å¤ç”¨
è¿æ¥1: [è¯·æ±‚1] [è¯·æ±‚2] [è¯·æ±‚3]
         â†“       â†“       â†“
      [å“åº”1] [å“åº”2] [å“åº”3]  # å¯ä»¥ä¹±åºè¿”å›ï¼
```
- ä½¿ç”¨ **Stream ID** æ ‡è¯†æ¯ä¸ªè¯·æ±‚-å“åº”å¯¹
- å“åº”å¯ä»¥ä¹±åºè¿”å›ï¼Œä½†é€šè¿‡ Stream ID åŒ¹é…

#### B. æ— è¿æ¥ç‰¹æ€§

HTTP æœ¬èº«æ˜¯**æ— çŠ¶æ€**çš„ï¼š
- æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„
- æœåŠ¡å™¨ä¸è®°ä½ä¹‹å‰çš„è¯·æ±‚
- ä½†é€šè¿‡ **Session ID** ç­‰æœºåˆ¶å®ç°çŠ¶æ€ç®¡ç†

---

### 3ï¸âƒ£ æµè§ˆå™¨å±‚é¢ï¼ˆJavaScriptï¼‰

**æœºåˆ¶ï¼šPromise å’Œå›è°ƒå‡½æ•°**

#### Fetch API çš„å®ç°

```typescript
const promise1 = fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({message: 'æ¶ˆæ¯1'})
});

const promise2 = fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({message: 'æ¶ˆæ¯2'})
});

// æ¯ä¸ª Promise éƒ½ä¼šç­‰å¾…å®ƒè‡ªå·±çš„å“åº”
const response1 = await promise1;  // ç­‰å¾…å“åº”1
const response2 = await promise2;  // ç­‰å¾…å“åº”2
```

**æµè§ˆå™¨å†…éƒ¨çš„å¤„ç†ï¼š**

1. **åˆ›å»ºè¯·æ±‚å¯¹è±¡**ï¼š
   ```javascript
   // æµè§ˆå™¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºå†…éƒ¨çš„è¯·æ±‚å¯¹è±¡
   {
       id: 'internal_id_12345',  // å†…éƒ¨ID
       url: '/api/chat',
       method: 'POST',
       body: 'æ¶ˆæ¯1',
       promise: Promise<Response>  // å¯¹åº”çš„Promise
   }
   ```

2. **å‘é€åˆ°ç½‘ç»œå±‚**ï¼š
   - è¯·æ±‚é€šè¿‡ TCP è¿æ¥å‘é€
   - æµè§ˆå™¨è®°ä½è¿™ä¸ªè¿æ¥å’Œå¯¹åº”çš„ Promise

3. **æ¥æ”¶å“åº”**ï¼š
   - å½“å“åº”æ•°æ®åˆ°è¾¾æ—¶ï¼Œæµè§ˆå™¨æ ¹æ®**è¿æ¥æ ‡è¯†**æ‰¾åˆ°å¯¹åº”çš„ Promise
   - è§£æ HTTP å“åº”å¤´å’Œ body
   - **resolve** å¯¹åº”çš„ Promise

4. **Promise æœºåˆ¶ä¿è¯**ï¼š
   ```typescript
   fetch('/api/chat').then(response => {
       // è¿™ä¸ªå›è°ƒåªä¼šè¢«è¿™ä¸ªè¯·æ±‚çš„å“åº”è§¦å‘
       // ä¸ä¼šè¢«å…¶ä»–è¯·æ±‚çš„å“åº”è§¦å‘
   });
   ```

---

### 4ï¸âƒ£ åº”ç”¨å±‚é¢ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

è™½ç„¶ HTTP å±‚é¢å·²ç»ä¿è¯äº†å¯¹åº”å…³ç³»ï¼Œä½†åœ¨ä¸šåŠ¡å±‚é¢è¿˜éœ€è¦é¢å¤–çš„æ ‡è¯†ï¼š

#### Session IDï¼ˆä¼šè¯æ ‡è¯†ï¼‰

**ä½œç”¨ï¼šåŒºåˆ†ä¸åŒçš„ä¼šè¯**

```typescript
// è¯·æ±‚1
POST /chat
{
    "message": "ä½ å¥½",
    "session_id": "session_abc123"  // ä¼šè¯A
}

// è¯·æ±‚2
POST /chat
{
    "message": "hello",
    "session_id": "session_xyz789"  // ä¼šè¯B
}
```

**åç«¯å¤„ç†ï¼š**
```python
@app.post("/chat")
async def chat(request: ChatRequest):
    session_id = request.session_id
    
    # æ ¹æ® session_id è·å–è¯¥ä¼šè¯çš„å†å²
    history = db.get_session_messages(session_id)
    
    # è¿”å›å“åº”ï¼ˆè‡ªç„¶å¯¹åº”è¯¥ä¼šè¯ï¼‰
    return ChatResponse(
        reply="...",
        session_id=session_id  # è¿”å›ç›¸åŒçš„ session_id
    )
```

#### Message IDï¼ˆæ¶ˆæ¯æ ‡è¯†ï¼‰

**ä½œç”¨ï¼šå”¯ä¸€æ ‡è¯†æ¯æ¡æ¶ˆæ¯**

```python
# åç«¯è¿”å›æ—¶åŒ…å« message_id
ChatResponse(
    reply="ä½ å¥½ï¼",
    session_id="session_abc123",
    message_id=12345  # å”¯ä¸€æ ‡è¯†
)
```

**å‰ç«¯ä½¿ç”¨ï¼š**
```typescript
const response = await sendMessage({
    message: "ä½ å¥½",
    session_id: currentSessionId
});

// response.message_id å”¯ä¸€æ ‡è¯†è¿™æ¡åŠ©æ‰‹æ¶ˆæ¯
// å¯ä»¥ç”¨äºåç»­å¼•ç”¨ã€ç¼–è¾‘ã€åˆ é™¤ç­‰æ“ä½œ
```

---

## å®é™…ä»£ç ä¸­çš„ä¿è¯

### å‰ç«¯ (`api.ts`)

```typescript
export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {
    const response = await fetch(`${API_BASE_URL}/chat`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(request),
    });
    
    if (!response.ok) throw new Error('Failed to send message');
    
    // âœ… è¿™é‡Œçš„ response ä¸€å®šæ˜¯å¯¹åº”ä¸Šé¢ request çš„å“åº”
    // å› ä¸ºï¼š
    // 1. fetch() è¿”å›çš„ Promise åªä¼šè¢«è¿™ä¸ªè¯·æ±‚çš„å“åº” resolve
    // 2. HTTP åè®®ä¿è¯äº†è¯·æ±‚-å“åº”çš„å¯¹åº”å…³ç³»
    return response.json();
}
```

### å‰ç«¯ä½¿ç”¨ (`App.tsx`)

```typescript
const handleSend = async () => {
    const userMessage = inputMsg;
    
    // å‘é€è¯·æ±‚
    const response = await sendMessage({
        message: userMessage,
        session_id: currentSessionId,
        config_id: currentConfig?.id
    });
    
    // âœ… response ä¸€å®šå¯¹åº”ä¸Šé¢çš„ userMessage
    // å³ä½¿åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼š
    
    // Promise.all([
    //     sendMessage({message: "æ¶ˆæ¯1"}),  // Promise1
    //     sendMessage({message: "æ¶ˆæ¯2"}),  // Promise2
    //     sendMessage({message: "æ¶ˆæ¯3"})   // Promise3
    // ]);
    // æ¯ä¸ª Promise éƒ½ä¼šç­‰å¾…è‡ªå·±çš„å“åº”
};
```

### åç«¯ (`main.py`)

```python
@app.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    # âœ… FastAPI è‡ªåŠ¨å¤„ç†è¯·æ±‚-å“åº”çš„å¯¹åº”å…³ç³»
    # æ¯ä¸ªè¯·æ±‚éƒ½åœ¨ç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ä¸­å¤„ç†
    # è¿”å›å€¼ä¼šè‡ªåŠ¨å‘é€ç»™å¯¹åº”çš„ HTTP è¿æ¥
    
    # å¤„ç†é€»è¾‘...
    
    return ChatResponse(
        reply=processed_response,
        session_id=session.id,
        message_id=assistant_msg.id
    )
    # âœ… è¿™ä¸ªå“åº”ä¼šé€šè¿‡åŸæ¥çš„ HTTP è¿æ¥è¿”å›ç»™å¯¹åº”çš„è¯·æ±‚
```

---

## å¹¶å‘åœºæ™¯åˆ†æ

### åœºæ™¯ 1ï¼šåŒä¸€ä¼šè¯å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯

```typescript
// ç”¨æˆ·å¿«é€Ÿç‚¹å‡»å‘é€3æ¬¡
await sendMessage({message: "æ¶ˆæ¯1", session_id: "abc"});
await sendMessage({message: "æ¶ˆæ¯2", session_id: "abc"});
await sendMessage({message: "æ¶ˆæ¯3", session_id: "abc"});
```

**ä¿è¯æœºåˆ¶ï¼š**
1. **HTTP åè®®**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹çš„å“åº”
2. **await**ï¼šé¡ºåºç­‰å¾…ï¼Œä¸ä¼šæ··ä¹±
3. **session_id**ï¼šç¡®ä¿éƒ½åœ¨åŒä¸€ä¸ªä¼šè¯ä¸­
4. **message_id**ï¼šæ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€ ID

**åç«¯å¤„ç†ï¼š**
```python
# è¯·æ±‚1ï¼šæ”¶åˆ°"æ¶ˆæ¯1"ï¼Œè¿”å›å“åº”1ï¼ˆmessage_id=10ï¼‰
# è¯·æ±‚2ï¼šæ”¶åˆ°"æ¶ˆæ¯2"ï¼Œè¿”å›å“åº”2ï¼ˆmessage_id=11ï¼‰
# è¯·æ±‚3ï¼šæ”¶åˆ°"æ¶ˆæ¯3"ï¼Œè¿”å›å“åº”3ï¼ˆmessage_id=12ï¼‰
```

### åœºæ™¯ 2ï¼šå¹¶å‘å‘é€å¤šä¸ªè¯·æ±‚

```typescript
// ä¸ä½¿ç”¨ awaitï¼ŒåŒæ—¶å‘é€
const p1 = sendMessage({message: "æ¶ˆæ¯1"});
const p2 = sendMessage({message: "æ¶ˆæ¯2"});
const p3 = sendMessage({message: "æ¶ˆæ¯3"});

const [r1, r2, r3] = await Promise.all([p1, p2, p3]);
// r1 ä¸€å®šå¯¹åº”"æ¶ˆæ¯1"çš„å“åº”
// r2 ä¸€å®šå¯¹åº”"æ¶ˆæ¯2"çš„å“åº”
// r3 ä¸€å®šå¯¹åº”"æ¶ˆæ¯3"çš„å“åº”
```

**ä¿è¯æœºåˆ¶ï¼š**
- æ¯ä¸ª Promise é€šè¿‡**é—­åŒ…**æ•è·äº†è‡ªå·±çš„è¯·æ±‚ä¸Šä¸‹æ–‡
- HTTP/2 ä½¿ç”¨ **Stream ID** åŒºåˆ†ä¸åŒçš„è¯·æ±‚-å“åº”
- å³ä½¿å“åº”ä¹±åºåˆ°è¾¾ï¼Œä¹Ÿèƒ½æ­£ç¡®åŒ¹é…

---

## å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### âŒ é—®é¢˜ 1ï¼šé•¿æ—¶é—´ç­‰å¾…å¯¼è‡´è¶…æ—¶

```typescript
// è¯·æ±‚å‘å‡ºåï¼Œç­‰å¾…äº†60ç§’æ²¡æœ‰å“åº”
const response = await fetch('/api/chat', {
    timeout: 60000  // 60ç§’è¶…æ—¶
});
// è¶…æ—¶åï¼ŒPromise è¢« rejectï¼Œä¸ä¼šé”™è¯¯åŒ¹é…å…¶ä»–å“åº”
```

**è§£å†³ï¼š**
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- åç«¯ä¼˜åŒ–å“åº”é€Ÿåº¦

### âŒ é—®é¢˜ 2ï¼šç½‘ç»œä¸­æ–­

```typescript
try {
    const response = await sendMessage({message: "ä½ å¥½"});
} catch (error) {
    // ç½‘ç»œé”™è¯¯ï¼ŒPromise è¢« reject
    // ä¸ä¼šæ”¶åˆ°é”™è¯¯çš„å“åº”
}
```

**è§£å†³ï¼š**
- å®ç°é‡è¯•æœºåˆ¶
- æ˜¾ç¤ºé”™è¯¯æç¤º

### âŒ é—®é¢˜ 3ï¼šé‡å¤æ¸²æŸ“

```typescript
// å¦‚æœä¸å°å¿ƒå‘é€äº†é‡å¤è¯·æ±‚
sendMessage({message: "ä½ å¥½"});  // è¯·æ±‚1
sendMessage({message: "ä½ å¥½"});  // è¯·æ±‚2ï¼ˆé‡å¤ï¼‰

// ä¼šæ”¶åˆ°ä¸¤ä¸ªå“åº”ï¼Œå¯¼è‡´é‡å¤æ˜¾ç¤º
```

**è§£å†³ï¼š**
- å‘é€æ—¶ç¦ç”¨æŒ‰é’®
- ä½¿ç”¨è¯·æ±‚å»é‡
- æ£€æŸ¥ loading çŠ¶æ€

---

## æ€»ç»“

HTTP è¯·æ±‚-å“åº”çš„å¯¹åº”å…³ç³»æ˜¯é€šè¿‡**å¤šå±‚æœºåˆ¶**å…±åŒä¿è¯çš„ï¼š

| å±‚æ¬¡ | æœºåˆ¶ | ä½œç”¨ |
|-----|------|-----|
| **TCP å±‚** | è¿æ¥æ ‡è¯†ã€æ•°æ®é¡ºåº | ç‰©ç†å±‚é¢ä¿è¯æ•°æ®åˆ°è¾¾æ­£ç¡®çš„è¿æ¥ |
| **HTTP å±‚** | è¯·æ±‚-å“åº”æ¨¡å‹ã€Stream ID | åè®®å±‚é¢ä¿è¯è¯·æ±‚å¯¹åº”å“åº” |
| **æµè§ˆå™¨å±‚** | Promise æœºåˆ¶ã€å†…éƒ¨æ˜ å°„ | ä»£ç å±‚é¢ä¿è¯å¼‚æ­¥è°ƒç”¨çš„æ­£ç¡®æ€§ |
| **åº”ç”¨å±‚** | Session IDã€Message ID | ä¸šåŠ¡å±‚é¢åŒºåˆ†ä¼šè¯å’Œæ¶ˆæ¯ |

**å…³é”®ç‚¹ï¼š**
1. âœ… **æ¯ä¸ª `fetch()` è°ƒç”¨è¿”å›çš„ Promise åªä¼šè¢«å®ƒè‡ªå·±çš„å“åº” resolve**
2. âœ… **å³ä½¿å¹¶å‘å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªéƒ½èƒ½æ”¶åˆ°æ­£ç¡®çš„å“åº”**
3. âœ… **ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†è¯·æ±‚-å“åº”çš„æ˜ å°„å…³ç³»**

**ä½ åªéœ€è¦ï¼š**
```typescript
const response = await sendMessage(request);
// response ä¸€å®šå¯¹åº” requestï¼Œæ— éœ€æ‹…å¿ƒï¼
```

æµè§ˆå™¨å’Œ HTTP åè®®ä¼šå¸®ä½ å¤„ç†å¥½ä¸€åˆ‡ï¼ğŸ‰
